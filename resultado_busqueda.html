<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Vuelos</title>
    <link rel="stylesheet" href="CSS/estilos_busqueda.css">
</head>
<body>

<header id="encabezado">
    <div id="izquierda">
        <a href="reservas.html" id="reserva">Reservas vuelo</a>
        <a href="reservas_hoteles.html" id="reserva">Reservas hotel</a>
    </div>
    <div id="centro">
        <a href="index.html" class="logo"><img src="LogoOficial.png" alt="Logo"></a>
    </div>
    <div id="derecha">
        <span id="estadoSesion">
            <a href="inicio_sesion.html" id="entrar">Entrar</a>
        </span>
    </div>
</header>

<main id="contenedorBusqueda">
    <section id="resultados" class="resultado">
        </section>

    <nav id="navegacion" class="navegacion">
        <a href="#" class="linknav">«</a>
        <a href="#" class="linknav">‹</a>
        <a href="#" class="linknav">1</a>
        <span class="actual">2</span>
        <span class="puntos">…</span>
        <a href="#" class="linknav">16</a>
        <a href="#" class="linknav">17</a>
        <a href="#" class="linknav">›</a>
        <a href="#" class="linknav">»</a>
    </nav>

    <button id="inicio" class="boton"><a href="index.html">Inicio</a></button>
</main>

<footer id="PiePagina">
    Todos los derechos reservados DreamFlying © 2025
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // --- Variables de Estado y Datos ---
    const infoBusqueda = JSON.parse(localStorage.getItem("infoBusqueda")) || {};
    
    // Obtiene y limpia el modo de vuelo: 'soloida' o 'idayvuelta'
    let tipoVuelo = (infoBusqueda.tipoVuelo || "soloida").toLowerCase().trim();
    
    // Datos cargados desde el simulador
    const resultadosIda = JSON.parse(localStorage.getItem("resultadosVuelosIda")) || {};
    const resultadosVuelta = JSON.parse(localStorage.getItem("resultadosVuelosVuelta")) || {};
    const contenedor = document.getElementById("resultados");
    
    // Limpiar selección anterior al cargar
    localStorage.removeItem("vueloSeleccionado");

    // --- Función de CÁLCULO Y REDIRECCIÓN ---
    function procederACompra() {
        let vueloSel = JSON.parse(localStorage.getItem("vueloSeleccionado")) || {};
        let costoTotal = 0;

        if (vueloSel.ida && vueloSel.ida.precio) {
            costoTotal += parseFloat(vueloSel.ida.precio);
        }
        if (vueloSel.vuelta && vueloSel.vuelta.precio) {
            costoTotal += parseFloat(vueloSel.vuelta.precio);
        }

        sessionStorage.setItem('costoBoleto', costoTotal.toFixed(2));
        alert(`¡Compra lista!\nCosto Total: ${costoTotal.toFixed(2)} Bs.\nRedirigiendo a datos personales...`);
        window.location.href = "llenar datos.html";
    }

    // --- Función de RENDERIZADO ADAPTADO AL SIMULADOR ---
    function renderizarVuelos(vuelos, esIda) {
        
        window.scrollTo({ top: 0, behavior: 'smooth' });

        contenedor.innerHTML = "";
        
        const titulo = document.createElement("h2");
        const direccion = esIda 
            ? `${infoBusqueda.origenNombre} → ${infoBusqueda.destinoNombre}`
            : `${infoBusqueda.destinoNombre} → ${infoBusqueda.origenNombre}`;
            
        titulo.textContent = (esIda ? "✈️ IDA: " : "↩️ VUELTA: ") + direccion;
        contenedor.appendChild(titulo);

        // Validación de resultados
        if (!vuelos || vuelos.length === 0) {
            contenedor.innerHTML += `<div class="mensaje-error">
                <p>No se encontraron vuelos disponibles para el trayecto de ${esIda ? "IDA" : "VUELTA"}.</p>
                <button class="boton" onclick="window.history.back()">Volver a buscar</button>
            </div>`;
            return;
        }

        vuelos.forEach((vuelo) => {
            
            // Extracción de datos del objeto simulado (estructura simple)
            const origen = vuelo.origen;
            const destino = vuelo.destino;
            const aerolinea = vuelo.aerolinea;
            const precio = vuelo.precio;
            const duracion = vuelo.duracion;
            const salida = vuelo.salida.slice(11, 16); 
            const llegada = vuelo.llegada.slice(11, 16); 
            const escalaTexto = "Directo"; // Asumido para la simulación
            
            const card = document.createElement("article");
            card.classList.add("cuadroResultado");

            card.innerHTML = 
                `<div class="informacion">
                    <img src="img/logos/${aerolinea}.svg" alt="${aerolinea}" class="aerolinea" onerror="this.style.display='none'">
                    <div class="detalles">
                        <h4>${aerolinea}</h4>
                        <p><strong>${origen}</strong> ➝ <strong>${destino}</strong></p>
                        <p>Salida: ${salida} - Llegada: ${llegada} (${duracion})</p>
                        <p>${escalaTexto}</p>
                        <p class="precio-vuelo">${parseFloat(precio).toFixed(2)} Bs</p>
                    </div>
                </div>
                <button class="boton seleccionarVuelo">Seleccionar</button>`;
            
            contenedor.appendChild(card);

            // Lógica de selección del botón
            card.querySelector(".seleccionarVuelo").addEventListener("click", () => {
                let vueloSel = JSON.parse(localStorage.getItem("vueloSeleccionado")) || {};
                
                const datosVuelo = { origen, destino, salida, llegada, aerolinea, precio, escala: escalaTexto, duracion };

                // 1. Si es IDA
                if (esIda) {
                    vueloSel.ida = datosVuelo;
                    localStorage.setItem("vueloSeleccionado", JSON.stringify(vueloSel));

                    // REQUERIMIENTO: Si es ida y vuelta, mostrar la vuelta. Si no, finalizar.
                    if (tipoVuelo === "idayvuelta") {
                        alert("Vuelo de ida guardado. Ahora selecciona el de vuelta.");
                        
                        // Renderizar los resultados de la VUELTA
                        const datosVuelta = resultadosVuelta.data || [];
                        renderizarVuelos(datosVuelta, false); 
                    } else {
                        // Es solo ida, finalizar compra
                        procederACompra();
                    }
                } 
                // 2. Si es VUELTA (esIda == false)
                else {
                    vueloSel.vuelta = datosVuelo;
                    localStorage.setItem("vueloSeleccionado", JSON.stringify(vueloSel));
                    // Finalizar compra (ya se seleccionó ida y vuelta)
                    procederACompra();
                }
            });
        });
    }

    // Inicializa la vista mostrando los resultados de IDA
    renderizarVuelos(resultadosIda.data || [], true);
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const usuarioLogeado = sessionStorage.getItem('usuarioLogeado');
        const estadoSesionElement = document.getElementById('estadoSesion');

        if (estadoSesionElement && usuarioLogeado) {
            const nombreSpan = document.createElement('span');
            nombreSpan.textContent = usuarioLogeado;
            nombreSpan.style.fontWeight = 'bold';
            nombreSpan.style.color = '#1d4e89'; 

            const cerrarSesionLink = document.createElement('a');
            cerrarSesionLink.href = '#';
            cerrarSesionLink.textContent = ' (Cerrar Sesión)';
            cerrarSesionLink.style.marginLeft = '10px';
            cerrarSesionLink.style.color = '#CC0000';
            cerrarSesionLink.style.textDecoration = 'none';
            
            cerrarSesionLink.onclick = function(e) {
                e.preventDefault(); 
                sessionStorage.clear(); 
                localStorage.removeItem('historialReservas'); 
                alert('Sesión cerrada. Serás redirigido.');
                window.location.href = 'index.html'; 
            };

            estadoSesionElement.innerHTML = '';
            estadoSesionElement.appendChild(nombreSpan);
            estadoSesionElement.appendChild(cerrarSesionLink);
        } else if (estadoSesionElement) {
            estadoSesionElement.innerHTML = '<a href="inicio_sesion.html" id="entrar">Entrar</a>';
        }
    });
</script>
</body>
</html>