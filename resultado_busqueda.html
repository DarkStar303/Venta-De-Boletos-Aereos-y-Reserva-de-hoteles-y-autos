<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados de Vuelos</title>
    <link rel="stylesheet" href="css/estilos_busqueda.css">
</head>
<body>

<header id="encabezado">
    <div id="izquierda">
        <a href="reservas.html" id="reserva">Reservas vuelo</a>
        <a href="reservas_hoteles.html" id="reserva">Reservas hotel</a>
    </div>
    <div id="centro">
        <a href="index.html" class="logo"><img src="LogoOficial.png" alt="Logo"></a>
    </div>
    <div id="derecha">
        <span id="estadoSesion">
            <a href="inicio_sesion.html" id="entrar">Entrar</a>
        </span>
    </div>
</header>

<main id="contenedorBusqueda">
    <section id="resultados" class="resultado">
    </section>

    <nav id="navegacion" class="navegacion">
        <a href="#" class="linknav">«</a>
        <a href="#" class="linknav">‹</a>
        <a href="#" class="linknav">1</a>
        <span class="actual">2</span>
        <span class="puntos">…</span>
        <a href="#" class="linknav">16</a>
        <a href="#" class="linknav">17</a>
        <a href="#" class="linknav">›</a>
        <a href="#" class="linknav">»</a>
    </nav>

    <button id="inicio" class="boton"><a href="index.html">Inicio</a></button>
</main>

<footer id="PiePagina">
    Todos los derechos reservados DreamFlying © 2025
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // --- Variables de Estado y Datos ---
    const infoBusqueda = JSON.parse(localStorage.getItem("infoBusqueda")) || {};
    const tipoVuelo = infoBusqueda.tipoVuelo || "soloida";
    const resultadosIda = JSON.parse(localStorage.getItem("resultadosVuelosIda")) || {};
    const resultadosVuelta = JSON.parse(localStorage.getItem("resultadosVuelosVuelta")) || {};
    const contenedor = document.getElementById("resultados");
    
    // Limpiar selección anterior (solo al cargar la página por primera vez)
    localStorage.removeItem("vueloSeleccionado");

    // --- Función de CÁLCULO Y REDIRECCIÓN ---
    function procederACompra() {
        let vueloSel = JSON.parse(localStorage.getItem("vueloSeleccionado")) || {};
        let costoTotal = 0;

        if (vueloSel.ida && vueloSel.ida.precio) {
            costoTotal += parseFloat(vueloSel.ida.precio);
        }
        if (vueloSel.vuelta && vueloSel.vuelta.precio) {
            costoTotal += parseFloat(vueloSel.vuelta.precio);
        }

        // 1. Guardar el costo total
        sessionStorage.setItem('costoBoleto', costoTotal.toFixed(2));
        
        alert(`¡Compra lista!\nCosto Total: ${costoTotal.toFixed(2)} Bs.\nRedirigiendo a datos personales...`);

        // 2. Redirigir a la siguiente etapa
        window.location.href = "llenar datos.html";
    }

    // --- Función de RENDERIZADO Y LÓGICA DE SELECCIÓN ---
    function renderizarVuelos(vuelos, esIda) {
        
        contenedor.innerHTML = "";
        
        const titulo = document.createElement("h2");
        titulo.textContent = esIda ? "✈️ Selecciona tu Vuelo de IDA" : "↩️ Selecciona tu Vuelo de VUELTA";
        contenedor.appendChild(titulo);

        if (!vuelos || vuelos.length === 0) {
            contenedor.innerHTML += "<p>No se encontraron vuelos para esta etapa.</p>";
            return;
        }

        vuelos.forEach((vuelo) => {
            vuelo.itineraries.forEach(itinerario => {

                const segments = itinerario.segments;
                const origen = segments[0].departure.iataCode;
                const destino = segments[segments.length - 1].arrival.iataCode;
                const salida = segments[0].departure.at.slice(11,16);
                const llegada = segments[segments.length - 1].arrival.at.slice(11,16);
                const aerolinea = segments[0].carrierCode;
                
                const escalaTexto = segments.length > 1 
                    ? `Escalas: ${segments.slice(0, -1).map(s => s.arrival.iataCode).join(" → ")}`
                    : "Directo";
                const precio = vuelo.price.total;

                const card = document.createElement("article");
                card.classList.add("cuadroResultado");

                card.innerHTML = 
                    `<div class="informacion">
                        <img src="img/logos/${aerolinea}.svg" alt="${aerolinea}" class="aerolinea">
                        <div class="detalles">
                            <h4>${aerolinea}</h4>
                            <p>${origen} - ${destino}</p>
                            <p>${salida} - ${llegada}</p>
                            <p>${escalaTexto}</p>
                            <p class="precio-vuelo">${parseFloat(precio).toFixed(2)} Bs</p>
                        </div>
                    </div>
                    <button class="boton seleccionarVuelo" data-precio="${precio}">Seleccionar</button>`;
                
                contenedor.appendChild(card);

                // Lógica de selección del botón
                card.querySelector(".seleccionarVuelo").addEventListener("click", () => {
                    let vueloSel = JSON.parse(localStorage.getItem("vueloSeleccionado")) || {};
                    const datosVuelo = { origen, destino, salida, llegada, aerolinea, precio, escala: escalaTexto };

                    // MODO: SOLO IDA
                    if (tipoVuelo === "soloida") {
                        vueloSel.ida = datosVuelo;
                        localStorage.setItem("vueloSeleccionado", JSON.stringify(vueloSel));
                        procederACompra();
                        return;
                    }

                    // MODO: IDA Y VUELTA
                    if (esIda) {
                        // 1. Selecciona la IDA
                        vueloSel.ida = datosVuelo;
                        localStorage.setItem("vueloSeleccionado", JSON.stringify(vueloSel));
                        alert("Vuelo de ida seleccionado. Ahora elige la vuelta.");
                        
                        // 2. Cambia la vista a los vuelos de vuelta
                        renderizarVuelos(resultadosVuelta.data || [], false); 
                    } 
                    else { 
                        // Es el vuelo de vuelta (esIda es false)
                        // 3. Selecciona la VUELTA
                        vueloSel.vuelta = datosVuelo;
                        localStorage.setItem("vueloSeleccionado", JSON.stringify(vueloSel));
                        
                        // Llama a la función de cálculo y redirección
                        procederACompra();
                    }
                });
            });
        });
    }

    // Inicializa la vista al cargar la página
    if (tipoVuelo === "soloida" || tipoVuelo === "idayvuelta") {
        renderizarVuelos(resultadosIda.data || [], true);
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const usuarioLogeado = sessionStorage.getItem('usuarioLogeado');
        const estadoSesionElement = document.getElementById('estadoSesion');

        if (estadoSesionElement && usuarioLogeado) {
            const nombreSpan = document.createElement('span');
            nombreSpan.textContent = usuarioLogeado;
            nombreSpan.style.fontWeight = 'bold';
            nombreSpan.style.color = '#1d4e89'; 

            const cerrarSesionLink = document.createElement('a');
            cerrarSesionLink.href = '#';
            cerrarSesionLink.textContent = ' (Cerrar Sesión)';
            cerrarSesionLink.style.marginLeft = '10px';
            cerrarSesionLink.style.color = '#CC0000';
            cerrarSesionLink.style.textDecoration = 'none';
            
            cerrarSesionLink.onclick = function(e) {
                e.preventDefault(); 
                sessionStorage.clear(); 
                localStorage.removeItem('historialReservas'); 
                alert('Sesión cerrada. Serás redirigido.');
                window.location.href = 'index.html'; 
            };

            estadoSesionElement.innerHTML = '';
            estadoSesionElement.appendChild(nombreSpan);
            estadoSesionElement.appendChild(cerrarSesionLink);
        } else if (estadoSesionElement) {
            estadoSesionElement.innerHTML = '<a href="inicio_sesion.html" id="entrar">Entrar</a>';
        }
    });
</script>
</body>
</html>