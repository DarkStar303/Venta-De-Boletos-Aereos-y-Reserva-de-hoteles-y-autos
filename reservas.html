<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Reservas</title>
    <link rel="stylesheet" href="CSS/estilos_reservas.css">
</head>
<body>

<header id="encabezado">
    <div id="izquierda">
        <a href="reservas.html" id="reserva">Reservas vuelo</a>
        <a href="reservas_hoteles.html" id="reserva">Reservas hotel</a>
    </div>
    <div id="centro">
        <a href="index.html" class="logo"><img src="LogoOficial.png" alt="Logo"></a>
    </div>
    <div id="derecha">
        <span id="estadoSesion">
            <a href="inicio_sesion.html" id="entrar">Entrar</a>
        </span>
    </div>
</header>

<main id="contenedorBusqueda">
    <h2 id="tituloReservas">Tus Viajes y Reservas</h2>
    
    <section id="listaReservas" class="resultado">
        <p id="mensajeVacio" style="text-align: center; color: #777; font-size: 1.2em; padding: 20px; display: none;">
            Parece que aún no tienes boletos confirmados. ¡Empieza tu búsqueda ahora!
        </p>
    </section>

    <button id="inicio" class="boton"><a href="index.html" style="text-decoration: none; color: inherit;">Volver al Inicio</a></button>

</main>

<footer id="PiePagina">
    Todos los derechos reservados DreamFlying © 2025
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializa ambas funciones al cargar la página
        verificarEstadoSesion();
        cargarReservas();
    });

    /**
     * Muestra el estado de la sesión (Entrar o Email + Cerrar Sesión).
     */
    function verificarEstadoSesion() {
        const usuarioLogeado = sessionStorage.getItem('usuarioLogeado');
        const estadoSesionElement = document.getElementById('estadoSesion');

        if (estadoSesionElement && usuarioLogeado) {
            const nombreSpan = document.createElement('span');
            nombreSpan.textContent = usuarioLogeado;
            nombreSpan.style.fontWeight = 'bold';
            nombreSpan.style.color = '#1d4e89'; 

            const cerrarSesionLink = document.createElement('a');
            cerrarSesionLink.href = '#';
            cerrarSesionLink.textContent = ' (Cerrar Sesión)';
            cerrarSesionLink.style.marginLeft = '10px';
            cerrarSesionLink.style.color = '#CC0000'; 
            cerrarSesionLink.style.textDecoration = 'none';
            
            cerrarSesionLink.onclick = function(e) {
                e.preventDefault(); 
                sessionStorage.clear();
                alert('Sesión cerrada. Serás redirigido.');
                window.location.href = 'index.html'; 
            };

            estadoSesionElement.innerHTML = '';
            estadoSesionElement.appendChild(nombreSpan);
            estadoSesionElement.appendChild(cerrarSesionLink);
        } else if (estadoSesionElement) {
             estadoSesionElement.innerHTML = '<a href="inicio_sesion.html" id="entrar">Entrar</a>';
        }
    }


    /**
     * Carga y renderiza el historial de reservas de vuelos guardado en localStorage.
     */
    function cargarReservas() {
        const historialReservasJSON = localStorage.getItem('historialReservas');
        const listaReservas = document.getElementById('listaReservas');
        const mensajeVacio = document.getElementById('mensajeVacio');
        
        listaReservas.innerHTML = ''; 

        if (!historialReservasJSON) {
            mensajeVacio.style.display = 'block';
            return;
        }

        const historialReservas = JSON.parse(historialReservasJSON);

        if (historialReservas.length === 0) {
            mensajeVacio.style.display = 'block';
            return;
        }

        mensajeVacio.style.display = 'none';

        historialReservas.forEach((reserva, index) => {
            const datosVuelo = reserva.datosVuelo || {}; 
            const vueloIda = datosVuelo.ida || {}; 
            const vueloVuelta = datosVuelo.vuelta; 

            // Determinar etiqueta para el vuelo de IDA
            const etiquetaIda = 'IDA'; 

            // --- DETALLES DE VUELO DE IDA ---
            let detallesHTML = `
                <div class="vuelo-segmento">
                    <h4 class="textoaerolinea">${vueloIda.aerolinea || 'Aerolínea Desconocida'} (${etiquetaIda})</h4>
                    <p class="ruta"><strong>${vueloIda.origen || '?'}</strong> a <strong>${vueloIda.destino || '?'}</strong></p>
                    <p class="tiempo">Salida: ${vueloIda.salida || '--'} | Llegada: ${vueloIda.llegada || '--'} | Escala: ${vueloIda.escala || 'No definido'}</p>
                    </div>
            `;

            // --- DETALLES DE VUELO DE VUELTA (si existe) ---
            if (vueloVuelta) {
                detallesHTML += `
                    <hr style="border-top: 1px dashed #ddd; margin: 10px 0;">
                    <div class="vuelo-segmento">
                        <h4 class="textoaerolinea">${vueloVuelta.aerolinea || 'Aerolínea Desconocida'} (VUELTA)</h4>
                        <p class="ruta"><strong>${vueloVuelta.origen || '?'}</strong> a <strong>${vueloVuelta.destino || '?'}</strong></p>
                        <p class="tiempo">Salida: ${vueloVuelta.salida || '--'} | Llegada: ${vueloVuelta.llegada || '--'} | Escala: ${vueloVuelta.escala || 'No definido'}</p>
                        </div>
                `;
            }

            // --- ESTRUCTURA DE LA TARJETA FINAL ---
            const cardReserva = document.createElement('article');
            cardReserva.classList.add('cuadroResultado'); 

            cardReserva.innerHTML = `
                <div class="informacion">
                    <img src="avion.png" alt="Icono de Aerolínea" class="aerolinea">
                    ${detallesHTML}
                </div>

                <div class="resumen-pago">
                    <p class="detalle-adicional">
                        Comprador: <strong>${reserva.nombrePasajeroPrincipal || 'N/A'}</strong>
                    </p>
                    <p class="detalle-adicional">
                        Fecha de Compra: <strong>${reserva.fechaCompra || 'N/A'}</strong>
                    </p>
                    <div class="precio">
                        <p style="font-weight: bold; font-size: 1.1em;">TOTAL PAGADO: ${reserva.costoPagado || '0.00'} Bs</p>
                        <p style="font-size: 0.9em; color: green; font-weight: bold;">Estado: ${(reserva.estado || 'CONFIRMADO').toUpperCase()}</p>
                    </div>
                </div>
            `;
            
            listaReservas.appendChild(cardReserva);
        });
    }
</script>
</body>
</html>